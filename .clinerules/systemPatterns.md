# Nova Forum 系统架构

## 整体架构设计

Nova Forum 采用经典的 **Spring Boot MVC 分层架构**，结合现代化的技术栈实现高性能、安全可靠的社区论坛平台。

### 架构概览

```
┌─────────────────────────────────────────────────────────────┐
│                    前端层 (Frontend Layer)                    │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │
│  │   Web App   │  │   Mobile    │  │  第三方API   │       │
│  │  (React)    │  │     App     │  │  集成       │       │
│  └─────────────┘  └─────────────┘  └─────────────┘       │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    API网关层 (API Gateway)                    │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │
│  │   RESTful   │  │    JWT      │  │   负载均衡   │       │
│  │    API      │  │   认证       │  │   & 限流    │       │
│  └─────────────┘  └─────────────┘  └─────────────┘       │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   业务逻辑层 (Business Layer)                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │
│  │ Controller  │  │   Service   │  │    业务     │       │
│  │    控制器   │  │   服务层     │  │   逻辑       │       │
│  └─────────────┘  └─────────────┘  └─────────────┘       │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    数据访问层 (Data Access Layer)            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │
│  │  Mapper &   │  │   MyBatis   │  │    事务     │       │
│  │   DTOs      │  │     Plus    │  │   管理       │       │
│  └─────────────┘  └─────────────┘  └─────────────┘       │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    数据存储层 (Data Storage Layer)           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │
│  │    MySQL    │  │   Redis     │  │Elasticsearch│       │
│  │   主数据库   │  │   缓存层     │  │   搜索引擎    │       │
│  └─────────────┘  └─────────────┘  └─────────────┘       │
└─────────────────────────────────────────────────────────────┘
```

## 分层架构模式

### 1. Controller 层 (Web Layer)
- **职责**: 处理HTTP请求，参数验证，响应格式化
- **技术**: Spring MVC 控制器
- **模式**: RESTful API 设计
- **职责划分**:
  - `UserController`: 用户相关API（注册、登录、个人信息）
  - `PostController`: 帖子相关API（发布、查询、更新、删除）

**设计原则**:
- 无业务逻辑，仅处理请求/响应
- 参数验证和异常处理
- 统一的响应格式
- Swagger文档集成

### 2. Service 层 (Business Logic Layer)
- **职责**: 实现核心业务逻辑，数据验证，事务管理
- **技术**: Spring Service 注解
- **模式**: 依赖注入，事务管理
- **核心服务**:
  - `UserServiceImpl`: 用户管理业务逻辑
  - `PostServiceImpl`: 帖子管理业务逻辑

**设计原则**:
- 单一职责原则
- 事务边界定义
- 业务规则封装
- 可测试性设计

### 3. Mapper 层 (Data Access Layer)
- **职责**: 数据库访问，SQL执行，数据持久化
- **技术**: MyBatis Plus + MySQL
- **模式**: ORM 对象关系映射
- **核心组件**:
  - `UserMapper`: 用户数据访问
  - `PostMapper`: 帖子数据访问

**设计原则**:
- 透明数据库操作
- SQL优化和性能考虑
- 连接池管理
- 事务一致性

### 4. Entity & DTO 层 (Model Layer)
- **职责**: 数据模型定义，传输对象，序列化
- **技术**: Lombok + Jakarta Validation
- **模式**: POJO 对象建模

**Entity类**:
- `User`: 用户实体模型
- `Post`: 帖子实体模型

**DTO类**:
- `RegisterRequest`: 注册请求数据
- `LoginRequest`: 登录请求数据  
- `PostRequest`: 帖子请求数据
- `PostResponse`: 帖子响应数据
- `ApiResponse`: 统一API响应格式

**设计原则**:
- 字段验证注解
- 数据序列化控制
- 避免循环引用
- 版本兼容性

## 安全架构模式

### 1. JWT 无状态认证
```
客户端登录 → 服务器生成JWT Token → 客户端存储Token → API请求携带Token → 服务器验证Token → 处理业务
```

**核心组件**:
- `JwtUtil`: JWT生成、验证、解析
- `JwtAuthenticationFilter`: JWT过滤器
- `SecurityConfig`: Spring Security配置

**安全特性**:
- 无会话状态，支持分布式部署
- Token过期时间控制（7天）
- 密码加密存储（BCrypt + 随机盐值）
- 防止重放攻击

### 2. Spring Security 集成
```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    // 配置请求授权规则
    // JWT过滤器链
    // 会话管理禁用
}
```

**配置策略**:
- 开放注册/登录接口
- API接口权限控制
- CSRF防护禁用（JWT无状态）
- 密码加密策略

## 数据架构模式

### 1. MySQL 主数据库
**核心表结构**:
```sql
-- 用户表
user (id, username, password, salt, email, create_time, update_time)

-- 帖子表  
post (id, user_id, title, content, view_count, like_count, create_time, update_time)

-- 评论表 (规划中)
comment (id, post_id, user_id, parent_id, content, create_time)
```

**设计原则**:
- 外键约束确保数据一致性
- 索引优化查询性能
- 软删除考虑数据恢复
- 时间戳自动维护

### 2. Redis 缓存架构 (规划中)
**缓存策略**:
```
热点数据 → Redis缓存 → 查询优化
用户点赞状态 → 分布式缓存 → 性能提升
会话数据 → Token缓存 → 快速验证
```

**缓存场景**:
- 点赞数统计缓存
- 用户登录状态缓存
- 热门帖子排行榜
- 搜索结果缓存

### 3. Elasticsearch 搜索架构 (规划中)
**索引设计**:
```
帖子索引: title + content + author + tags
用户索引: username + email + profile
评论索引: content + post_id + author
```

**搜索功能**:
- 全文检索和高亮显示
- 分词和同义词处理
- 搜索结果排序
- 搜索热度统计

## 性能优化模式

### 1. 数据库优化
- **索引策略**: 主键索引、复合索引、唯一索引
- **查询优化**: 使用QueryWrapper、分页查询
- **连接池**: HikariCP连接池配置
- **慢查询监控**: SQL执行时间监控

### 2. 缓存策略
- **多级缓存**: 本地缓存 + Redis分布式缓存
- **缓存预热**: 应用启动时预加载热点数据
- **缓存更新**: 写通模式与写回模式结合
- **缓存穿透**: 布隆过滤器防止恶意查询

### 3. 响应式设计
- **异步处理**: 非关键业务异步执行
- **批处理**: 批量数据库操作
- **分页加载**: 大数据量分页查询
- **数据压缩**: JSON序列化优化

## 部署架构模式

### 1. 容器化部署 (Docker)
```
应用容器 (Spring Boot) + 数据容器 (MySQL) + 缓存容器 (Redis) + 搜索容器 (Elasticsearch)
```

**服务编排**:
- Docker Compose 配置文件
- 环境变量配置
- 网络隔离和安全组
- 数据持久化策略

### 2. 高可用架构 (规划中)
```
负载均衡器 → 多应用实例 → 数据集群 → 缓存集群 → 搜索集群
```

**容错机制**:
- 应用实例冗余
- 数据库主从复制
- 缓存雪崩防护
- 熔断降级策略

## 开发规范模式

### 1. 代码组织结构
```
src/main/java/com/novaforum/nova_forum/
├── config/          # 配置类
├── controller/      # 控制器层
├── service/         # 服务层
│   └── impl/        # 服务实现
├── mapper/          # 数据访问层
├── entity/          # 实体模型
├── dto/             # 数据传输对象
├── util/            # 工具类
└── NovaForumApplication.java  # 启动类
```

### 2. 命名约定
- **类名**: PascalCase（如：UserService）
- **方法名**: camelCase（如：getUserById）
- **变量名**: camelCase（如：userId）
- **常量**: UPPER_SNAKE_CASE（如：MAX_LENGTH）

### 3. 注释规范
- **类注释**: 说明类职责和用途
- **方法注释**: 功能说明、参数含义、返回值
- **复杂逻辑**: 行内注释解释业务逻辑
- **API文档**: Swagger注解自动生成文档

## 错误处理模式

### 1. 全局异常处理
```java
@RestControllerAdvice
public class GlobalExceptionHandler {
    // 统一异常处理
    // 错误响应格式化
    // 日志记录
}
```

### 2. 错误分类
- **业务异常**: 业务逻辑错误（如：用户不存在）
- **参数异常**: 输入验证错误（如：格式不正确）
- **系统异常**: 技术异常（如：数据库连接失败）
- **认证异常**: 安全异常（如：Token无效）

### 3. 响应格式统一
```json
{
  "code": 200,
  "message": "success",
  "data": {}
}
```

## 测试架构模式

### 1. 测试层次
- **单元测试**: Service层业务逻辑测试
- **集成测试**: Controller层API测试  
- **端到端测试**: 完整业务流程测试

### 2. 测试工具
- **Junit 5**: 单元测试框架
- **Spring Boot Test**: 集成测试
- **Mockito**: 模拟对象
- **Testcontainers**: 数据库测试

## 监控和日志模式

### 1. 日志策略
- **日志级别**: DEBUG < INFO < WARN < ERROR
- **日志格式**: 时间戳 + 级别 + 类名 + 消息
- **敏感信息**: 密码等不写入日志
- **日志轮转**: 按日期和大小轮转

### 2. 监控指标 (规划中)
- **应用指标**: QPS、响应时间、错误率
- **系统指标**: CPU、内存、磁盘使用率
- **业务指标**: 用户活跃度、内容质量
- **告警机制**: 异常情况自动告警

*Nova Forum的系统架构采用成熟的设计模式和最佳实践，确保代码质量、性能表现和长期可维护性。*
